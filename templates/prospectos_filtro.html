{% extends "base.html" %}

{% block title %}{{ titulo_filtro }} - Sistema de Prospectos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-3 border-bottom">
    <div>
        <h1 class="h2">{{ titulo_filtro }}</h1>
        <p class="text-muted mb-0">Total: {{ total_prospectos }} prospectos</p>
    </div>
    <div>
        <a href="/dashboard" class="btn btn-secondary">Volver al Dashboard</a>
        <a href="/prospectos" class="btn btn-primary">Ver todos los prospectos</a>
    </div>
</div>

<!-- InformaciÃ³n del Filtro -->
<div class="alert alert-info">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <strong>Filtro aplicado:</strong> {{ titulo_filtro }}
            <span class="badge bg-primary ms-2">{{ total_prospectos }} registros</span>
        </div>
        <div>
            <small class="text-muted">PÃ¡gina {{ pagina_actual }} de {{ total_paginas }}</small>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Lista de Prospectos</h5>
                <span class="badge bg-primary">{{ prospectos|length }} en esta pÃ¡gina</span>
            </div>
            <div class="card-body">
                {% if prospectos %}
                <div class="table-responsive" style="max-height: 65vh; font-size: 0.85rem;">
                    <table class="table table-striped table-hover table-sm" style="font-size: 0.8rem;">
                        <thead class="table-dark">
                            <tr>
                                <th>Nombre</th>
                                <th>Contacto</th>
                                <th>Origen - Destino</th>
                                <th>Fechas</th>
                                <th>Pasajeros</th>
                                <th>Medio</th>
                                <th>Agente</th>
                                <th>Estado</th>
                                {% if current_user.tipo_usuario in ['administrador', 'supervisor'] and tipo_filtro in ['datos', 'asignacion', 'total'] %}
                                <th>Asignar</th>
                                {% endif %}
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for prospecto in prospectos %}
                            <tr>
                                <td>
                                    <div class="fw-bold">
                                        {% if prospecto.nombre and prospecto.apellido %}
                                            {{ prospecto.nombre }} {{ prospecto.apellido }}
                                        {% else %}
                                            <span class="text-muted">No registrado</span>
                                        {% endif %}
                                    </div>
                                    <small class="text-muted">ID: {{ prospecto.id }}</small>
                                    {% if prospecto.cliente_recurrente %}
                                    <span class="badge bg-warning" title="Cliente recurrente">ðŸ”„</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        {% if prospecto.correo_electronico %}
                                        <small class="text-primary text-truncate" style="max-width: 150px; font-size: 0.75rem;" 
                                                title="{{ prospecto.correo_electronico }}">
                                            ðŸ“§ {{ prospecto.correo_electronico }}
                                        </small>
                                        {% else %}
                                        <small class="text-muted" style="font-size: 0.75rem;">ðŸ“§ N/A</small>
                                        {% endif %}
                                        
                                        {% if prospecto.telefono %}
                                        <small class="text-success mt-1" style="font-size: 0.8rem;">
                                            ðŸ“ž +{{ prospecto.indicativo_telefono }} {{ prospecto.telefono }}
                                            <a href="/clientes/historial?telefono={{ prospecto.telefono }}" 
                                            class="text-success ms-1" title="Ver historial completo del cliente">
                                                ðŸ“‹
                                            </a>
                                            {% if prospecto.get_whatsapp_link() != "#" %}
                                            <a href="{{ prospecto.get_whatsapp_link() }}" target="_blank" class="text-success ms-1" title="Abrir WhatsApp">
                                                ðŸ’¬
                                            </a>
                                            {% endif %}
                                        </small>
                                        {% else %}
                                        <small class="text-muted" style="font-size: 0.8rem;">ðŸ“ž N/A</small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        <small><strong>Origen:</strong> {{ prospecto.ciudad_origen or 'N/A' }}</small>
                                        <small><strong>Destino:</strong> {{ prospecto.destino or 'N/A' }}</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex flex-column">
                                        {% if prospecto.fecha_ida %}
                                        <small><strong>Ida:</strong> {{ prospecto.fecha_ida.strftime('%d/%m/%Y') }}</small>
                                        {% else %}
                                        <small><strong>Ida:</strong> <span class="text-muted">N/A</span></small>
                                        {% endif %}
                                        
                                        {% if prospecto.fecha_vuelta %}
                                        <small><strong>Vuelta:</strong> {{ prospecto.fecha_vuelta.strftime('%d/%m/%Y') }}</small>
                                        {% else %}
                                        <small><strong>Vuelta:</strong> <span class="text-muted">N/A</span></small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td>
                                    <div class="text-center">
                                        <div class="fw-bold">{{ prospecto.pasajeros_adultos + prospecto.pasajeros_ninos + prospecto.pasajeros_infantes }}</div>
                                        <small class="text-muted">
                                            A:{{ prospecto.pasajeros_adultos }} 
                                            N:{{ prospecto.pasajeros_ninos }} 
                                            I:{{ prospecto.pasajeros_infantes }}
                                        </small>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ prospecto.medio_ingreso.nombre }}</span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ prospecto.agente_asignado.username if prospecto.agente_asignado else 'Sin asignar' }}</small>
                                </td>
                                <td>
                                    <span class="badge {% if prospecto.estado == 'nuevo' %}bg-secondary
                                        {% elif prospecto.estado == 'en_seguimiento' %}bg-primary
                                        {% elif prospecto.estado == 'cotizado' %}bg-warning
                                        {% elif prospecto.estado == 'cerrado_perdido' %}bg-danger
                                        {% else %}bg-success{% endif %}">
                                        {{ prospecto.estado|replace('_', ' ')|title }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="/prospectos/{{ prospecto.id }}/seguimiento" 
                                           class="btn btn-outline-info" title="Ver seguimiento">
                                            ðŸ“‹
                                        </a>
                                    </div>
                                </td>
                                {% if current_user.tipo_usuario in ['administrador', 'supervisor'] and tipo_filtro in ['datos', 'asignacion', 'total'] %}
                                <td>
                                    <form action="/prospectos/{{ prospecto.id }}/asignar" method="post" class="d-inline">
                                        <!-- âœ… PASAR TODOS LOS FILTROS ACTUALES -->
                                        <input type="hidden" name="fecha_inicio" value="{{ fecha_inicio_activa or '' }}">
                                        <input type="hidden" name="fecha_fin" value="{{ fecha_fin_activa or '' }}">
                                        <input type="hidden" name="periodo" value="{{ periodo_activo }}">
                                        <input type="hidden" name="tipo_filtro" value="{{ tipo_filtro }}">
                                        <input type="hidden" name="valor_filtro" value="{{ valor_filtro }}">
                                        <input type="hidden" name="pagina" value="{{ pagina_actual }}">
                                        
                                        <select name="agente_id" class="form-select form-select-sm" 
                                                onchange="this.form.submit()" style="min-width: 120px;">
                                            <option value="0">Sin asignar</option>
                                            {% for agente in agentes %}
                                            <option value="{{ agente.id }}" {% if prospecto.agente_asignado_id == agente.id %}selected{% endif %}>
                                                {{ agente.username }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </form>
                                </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- PaginaciÃ³n -->
                {% if total_paginas > 1 %}
                <nav aria-label="PaginaciÃ³n" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if pagina_actual > 1 %}
                        <li class="page-item">
                            <a class="page-link" href="/prospectos/filtro?tipo_filtro={{ tipo_filtro }}&valor_filtro={{ valor_filtro }}&pagina={{ pagina_actual - 1 }}">
                                Anterior
                            </a>
                        </li>
                        {% endif %}

                        {% for pagina in range(1, total_paginas + 1) %}
                            {% if pagina == pagina_actual %}
                            <li class="page-item active">
                                <span class="page-link">{{ pagina }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="/prospectos/filtro?tipo_filtro={{ tipo_filtro }}&valor_filtro={{ valor_filtro }}&pagina={{ pagina }}">
                                    {{ pagina }}
                                </a>
                            </li>
                            {% endif %}
                        {% endfor %}

                        {% if pagina_actual < total_paginas %}
                        <li class="page-item">
                            <a class="page-link" href="/prospectos/filtro?tipo_filtro={{ tipo_filtro }}&valor_filtro={{ valor_filtro }}&pagina={{ pagina_actual + 1 }}">
                                Siguiente
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}

                {% else %}
                <div class="text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-search fa-3x mb-3"></i>
                        <h5>No se encontraron prospectos</h5>
                        <p>No hay prospectos que coincidan con el filtro aplicado.</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
<!-- âœ… AGREGAR DATEPICKER -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar datepicker para campos de fecha
    const fechaInputs = document.querySelectorAll('input[placeholder="dd/mm/aaaa"]');
    
    fechaInputs.forEach(input => {
        flatpickr(input, {
            dateFormat: "d/m/Y",
            locale: "es",
            allowInput: true,
            disableMobile: true, // Para mejor experiencia en desktop
            onChange: function(selectedDates, dateStr, instance) {
                // Formatear automÃ¡ticamente mientras se escribe
                if (dateStr) {
                    instance.setDate(dateStr, true, "d/m/Y");
                }
            }
        });
    });
    
    // Mostrar/ocultar campos de fecha personalizada
    const selectPeriodo = document.getElementById('selectPeriodo');
    const fechaInicioGroup = document.getElementById('fechaInicioGroup');
    const fechaFinGroup = document.getElementById('fechaFinGroup');
    
    if (selectPeriodo) {
        selectPeriodo.addEventListener('change', function() {
            if (this.value === 'personalizado') {
                fechaInicioGroup.style.display = 'block';
                fechaFinGroup.style.display = 'block';
            } else {
                fechaInicioGroup.style.display = 'none';
                fechaFinGroup.style.display = 'none';
            }
        });
    }
});
</script>
<style>
.table-sm td, .table-sm th {
    padding: 0.5rem;
    vertical-align: middle;
}

.badge {
    font-size: 0.7rem;
}

.page-link {
    font-size: 0.9rem;
}
</style>
{% endblock %}