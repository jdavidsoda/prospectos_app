{% extends "base.html" %}

{% block title %}Seguimiento - {{ prospecto.nombre }} {{ prospecto.apellido }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-3 border-bottom">
    <div>
        <h1 class="h2 fw-bold text-dark mb-0">Seguimiento de Prospecto</h1>
        <div class="d-flex align-items-center mt-2">
            <h3 class="h5 text-muted mb-0 me-3">{{ prospecto.nombre }} {{ prospecto.apellido }}</h3>
            <span class="badge rounded-pill {% if prospecto.estado == 'nuevo' %}bg-soft-secondary text-secondary
                {% elif prospecto.estado == 'en_seguimiento' %}bg-soft-primary text-primary
                {% elif prospecto.estado == 'cotizado' %}bg-soft-warning text-warning
                {% elif prospecto.estado == 'cerrado_perdido' %}bg-soft-danger text-danger
                {% else %}bg-soft-success text-success{% endif %} me-2">
                {{ prospecto.estado|replace('_', ' ')|title }}
            </span>
            <span class="badge rounded-pill bg-light text-dark border me-2">
                <i class="fas fa-user-tie text-muted me-1"></i> {{ prospecto.agente_asignado.username }}
            </span>
            <span class="badge rounded-pill bg-soft-info text-info border">
                ID Cliente: {{ prospecto.id_cliente or 'N/A' }}
            </span>
        </div>
        <div class="mt-1 small text-muted">
            <span class="me-2">ID Sistema: #{{ prospecto.id }}</span>
        </div>
    </div>
    <div>
        <a href="/prospectos" class="btn btn-outline-secondary btn-sm rounded-pill"><i
                class="fas fa-arrow-left me-1"></i> Volver</a>
    </div>
</div>

<!-- Mensajes -->
{% if request.query_params.get('success') %}
<div class="alert alert-success alert-dismissible fade show" role="alert">
    {{ request.query_params.get('success') }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

{% if request.query_params.get('error') %}
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ request.query_params.get('error') }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row">
    <!-- Panel de Interacciones -->
    <div class="col-md-8">
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h5 class="card-title mb-0 fw-bold text-primary"><i class="fas fa-history me-2"></i>Historial de
                    Interacciones</h5>
            </div>
            <div class="card-body">
                <!-- Formulario para nueva interacci√≥n -->
                <div class="mb-4 p-3 border-0 bg-light rounded-3">
                    <h6 class="fw-bold mb-3">Registrar Nueva Interacci√≥n</h6>
                    <form method="post" action="/prospectos/{{ prospecto.id }}/interaccion">
                        <div class="mb-3">
                            <label class="form-label small text-muted">Descripci√≥n *</label>
                            <textarea class="form-control border-0 shadow-sm" name="descripcion" rows="3"
                                placeholder="Detalle de la interacci√≥n con el cliente..." required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Tipo de Interacci√≥n</label>
                                    <select class="form-select border-0 shadow-sm" name="tipo_interaccion">
                                        <option value="llamada">üìû Llamada</option>
                                        <option value="email">üìß Email</option>
                                        <option value="reunion">üë• Reuni√≥n</option>
                                        <option value="whatsapp">üí¨ WhatsApp</option>
                                        <option value="general" selected>üìù General</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Cambiar Estado</label>
                                    <select class="form-select border-0 shadow-sm" name="cambio_estado">
                                        <option value="">-- Mantener estado actual --</option>
                                        <option value="en_seguimiento">üîÑ En Seguimiento</option>
                                        <option value="cotizado">üí∞ Cotizado</option>
                                        <option value="ganado">‚úÖ Ganado</option>
                                        <option value="cerrado_perdido">‚ùå Cerrar (Perdido)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Pr√≥ximo Contacto</label>
                                    <input type="datetime-local" class="form-control border-0 shadow-sm"
                                        name="fecha_proximo_contacto">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-sm rounded-pill px-4">Registrar
                            Interacci√≥n</button>
                    </form>
                </div>

                <!-- Lista de interacciones -->
                <div class="interacciones-list">
                    {% if prospecto.interacciones %}
                    {% for interaccion in prospecto.interacciones %}
                    <div class="interaccion-item mb-3 p-3 border-0 rounded-3 shadow-sm bg-white position-relative">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="icon-shape icon-xs bg-soft-primary text-primary rounded-circle me-2"
                                        style="width: 24px; height: 24px;">
                                        <i class="fas fa-user"></i>
                                    </div>
                                    <strong class="me-2 text-dark">{{ interaccion.usuario.username }}</strong>
                                    <small class="text-muted ms-auto">
                                        {% if interaccion.id %}ID: #{{ interaccion.id }} &middot;{% endif %}
                                        {{ interaccion.fecha_creacion.strftime('%d/%m/%Y %H:%M') }}
                                    </small>
                                </div>
                                <div class="ps-4 ms-1 border-start border-2 border-light">
                                    <p class="mb-1 text-muted">{{ interaccion.descripcion }}</p>
                                    <span class="badge bg-light text-dark border">{{ interaccion.tipo_interaccion|title
                                        }}</span>

                                    {% if interaccion.estado_anterior and interaccion.estado_nuevo %}
                                    <div class="mt-2 text-xs">
                                        <span class="badge bg-soft-secondary text-secondary">
                                            {{ interaccion.estado_anterior|replace('_', ' ')|title }}
                                        </span>
                                        <i class="fas fa-arrow-right text-muted mx-1" style="font-size: 0.7rem;"></i>
                                        <span class="badge bg-soft-info text-info">
                                            {{ interaccion.estado_nuevo|replace('_', ' ')|title }}
                                        </span>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-center py-5">
                        <div class="icon-shape icon-lg bg-soft-secondary text-secondary rounded-circle mb-3 mx-auto">
                            <i class="far fa-comment-dots fa-2x"></i>
                        </div>
                        <p class="text-muted">No hay interacciones registradas a√∫n.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Panel de Documentos y Informaci√≥n -->
    <div class="col-md-4">
        <!-- Panel de Subida de Documentos -->
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="card-title mb-0 fw-bold text-dark"><i
                        class="fas fa-file-alt me-2 text-secondary"></i>Documentos</h6>
            </div>
            <div class="card-body">
                <form method="post" action="/prospectos/{{ prospecto.id }}/documento" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label small text-muted">Subir Documento (PDF)</label>
                        <input type="file" class="form-control form-control-sm" name="archivo" accept=".pdf" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label small text-muted">Tipo</label>
                        <select class="form-select form-select-sm" name="tipo_documento">
                            <option value="cotizacion">üìÑ Cotizaci√≥n</option>
                            <option value="contrato">üìë Contrato</option>
                            <option value="otro">üìé Otro</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <input type="text" class="form-control form-control-sm" name="descripcion"
                            placeholder="Descripci√≥n opcional...">
                    </div>

                    <button type="submit" class="btn btn-success btn-sm w-100 rounded-pill"><i
                            class="fas fa-upload me-1"></i> Subir</button>
                </form>

                <!-- Lista de documentos -->
                <div class="mt-4">
                    <h6 class="small text-muted fw-bold border-bottom pb-2 mb-3">Archivos Guardados</h6>
                    {% if prospecto.documentos %}
                    {% for documento in prospecto.documentos %}
                    <div class="documento-item p-2 border-0 bg-light rounded-3 mb-2 d-flex align-items-center">
                        <div class="me-3 text-danger"><i class="fas fa-file-pdf"></i></div>
                        <div class="flex-grow-1" style="min-width: 0;">
                            <div class="fw-bold small text-truncate">{{ documento.nombre_archivo }}</div>
                            <div class="text-muted text-xs">
                                ID: DOC-{{ documento.id }} &middot; {{ documento.tipo_documento|title }} &middot; {{
                                documento.fecha_subida.strftime('%d/%m') }}
                            </div>
                        </div>
                        <a href="/{{ documento.ruta_archivo }}" target="_blank"
                            class="btn btn-sm btn-light text-primary rounded-circle"><i class="fas fa-download"></i></a>
                    </div>
                    {% endfor %}
                    {% else %}
                    <p class="text-muted small text-center">No hay documentos.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Informaci√≥n del Prospecto -->
        <div class="card border-0 shadow-sm border-top border-4 border-info">
            <div class="card-body">
                <h6 class="card-title fw-bold text-dark mb-3">Informaci√≥n del Cliente</h6>

                <div class="mb-3">
                    <label class="small text-muted d-block">WhatsApp / Tel√©fono</label>
                    <div class="d-flex align-items-center">
                        <span class="fs-6 me-2">+{{ prospecto.indicativo_telefono }} {{ prospecto.telefono }}</span>
                        <a href="https://wa.me/{{ prospecto.indicativo_telefono }}{{ prospecto.telefono }}"
                            target="_blank" class="text-success"><i class="fab fa-whatsapp fa-lg"></i></a>
                    </div>
                </div>

                <div class="mb-2">
                    <small class="text-muted d-block">Email</small>
                    <span>{{ prospecto.correo_electronico or 'N/A' }}</span>
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Origen - Destino</small>
                    <span>{{ prospecto.ciudad_origen or 'N/A' }} <i
                            class="fas fa-long-arrow-alt-right mx-1 text-muted"></i> {{ prospecto.destino or 'N/A'
                        }}</span>
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Fechas</small>
                    <span>
                        {% if prospecto.fecha_ida %}
                        {{ prospecto.fecha_ida.strftime('%d/%m/%Y') }}
                        {% if prospecto.fecha_vuelta %}
                        - {{ prospecto.fecha_vuelta.strftime('%d/%m/%Y') }}
                        {% endif %}
                        {% else %}
                        N/A
                        {% endif %}
                    </span>
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Pasajeros</small>
                    <span>
                        <i class="fas fa-user text-muted me-1"></i>{{ prospecto.pasajeros_adultos }}
                        <i class="fas fa-child text-muted ms-2 me-1"></i>{{ prospecto.pasajeros_ninos }}
                        <i class="fas fa-baby text-muted ms-2 me-1"></i>{{ prospecto.pasajeros_infantes }}
                    </span>
                </div>
                <div class="mb-2">
                    <small class="text-muted d-block">Medio de Ingreso</small>
                    <span class="badge bg-light text-dark border">{{ prospecto.medio_ingreso.nombre }}</span>
                </div>
                {% if prospecto.observaciones %}
                <div class="mt-3 p-2 bg-light rounded small">
                    <strong>Observaciones:</strong>
                    <p class="text-muted mb-0">{{ prospecto.observaciones }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <!-- ‚úÖ NUEVA SECCI√ìN: Editar Informaci√≥n de Viaje -->
    <div class="card mt-4 border-0 shadow-sm" id="editar-viaje">
        <div class="card-header">
            <h6 class="card-title mb-0">‚úèÔ∏è Editar Informaci√≥n de Viaje</h6>
        </div>
        <div class="card-body">
            <form method="post" action="/prospectos/{{ prospecto.id }}/actualizar-viaje">
                <!-- Nombre y Apellido -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <input type="text" class="form-control" name="nombre" value="{{ prospecto.nombre or '' }}"
                                placeholder="Nombre del cliente">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Apellido</label>
                            <input type="text" class="form-control" name="apellido"
                                value="{{ prospecto.apellido or '' }}" placeholder="Apellido del cliente">
                        </div>
                    </div>
                </div>

                <!-- Email -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" name="correo_electronico"
                                value="{{ prospecto.correo_electronico or '' }}" placeholder="Email del cliente">
                        </div>
                    </div>
                </div>

                <!-- Tel√©fonos - Fila 1: Tel√©fono Principal -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Indicativo Principal</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">+</span>
                                <input type="text" class="form-control" name="indicativo_telefono"
                                    value="{{ prospecto.indicativo_telefono or '57' }}" placeholder="57"
                                    pattern="[0-9]{1,4}">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Tel√©fono Principal</label>
                            <input type="tel" class="form-control form-control-sm" name="telefono"
                                value="{{ prospecto.telefono or '' }}" placeholder="Ej: 3001234567">
                        </div>
                    </div>

                    <!-- Tel√©fono Secundario -->
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Indicativo Secundario</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">+</span>
                                <input type="text" class="form-control" name="indicativo_telefono_secundario"
                                    value="{{ prospecto.indicativo_telefono_secundario or '57' }}" placeholder="57"
                                    pattern="[0-9]{1,4}">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Tel√©fono Secundario</label>
                            <input type="tel" class="form-control form-control-sm" name="telefono_secundario"
                                value="{{ prospecto.telefono_secundario or '' }}" placeholder="Tel√©fono adicional">
                        </div>
                    </div>
                </div>

                <!-- Origen y Destino -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Ciudad de Origen</label>
                            <input type="text" class="form-control" name="ciudad_origen"
                                value="{{ prospecto.ciudad_origen or '' }}" placeholder="Ciudad de origen">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Destino</label>
                            <input type="text" class="form-control" name="destino" value="{{ prospecto.destino or '' }}"
                                placeholder="Destino del viaje">
                        </div>
                    </div>
                </div>

                <!-- Fechas -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Fecha Ida (dd/mm/aaaa)</label>
                            <input type="text" class="form-control date-picker-input" name="fecha_ida"
                                value="{% if prospecto.fecha_ida %}{{ prospecto.fecha_ida.strftime('%d/%m/%Y') }}{% endif %}"
                                placeholder="dd/mm/aaaa">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">Fecha Vuelta (dd/mm/aaaa)</label>
                            <input type="text" class="form-control date-picker-input" name="fecha_vuelta"
                                value="{% if prospecto.fecha_vuelta %}{{ prospecto.fecha_vuelta.strftime('%d/%m/%Y') }}{% endif %}"
                                placeholder="dd/mm/aaaa">
                        </div>
                    </div>
                </div>

                <!-- Pasajeros -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Adultos</label>
                            <input type="number" class="form-control" name="pasajeros_adultos"
                                value="{{ prospecto.pasajeros_adultos or 1 }}" min="1">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Ni√±os</label>
                            <input type="number" class="form-control" name="pasajeros_ninos"
                                value="{{ prospecto.pasajeros_ninos or 0 }}" min="0">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">Infantes</label>
                            <input type="number" class="form-control" name="pasajeros_infantes"
                                value="{{ prospecto.pasajeros_infantes or 0 }}" min="0">
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-save"></i> Actualizar Informaci√≥n de Viaje
                </button>
            </form>
        </div>
    </div>
</div>
<!-- ‚úÖ AGREGAR DATEPICKER -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Mostrar loading en formularios
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function () {
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn && !submitBtn.disabled) {
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                    submitBtn.disabled = true;

                    // Restaurar despu√©s de 5 segundos por si hay error
                    setTimeout(() => {
                        submitBtn.innerHTML = originalText;
                        submitBtn.disabled = false;
                    }, 5000);
                }
            });
        });
    });
</script>
{% endblock %}