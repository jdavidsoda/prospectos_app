{% extends "base.html" %}

{% block title %}Estad√≠sticas de Cotizaciones - Sistema de Prospectos{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-3 border-bottom">
    <h1 class="h2">Estad√≠sticas de Cotizaciones</h1>
    <div>
        <a href="/dashboard" class="btn btn-secondary">Volver al Dashboard</a>
    </div>
</div>

<!-- Filtros Compactos -->
<div class="card mb-4 border-0 shadow-sm bg-light">
    <div class="card-body py-2">
        <form method="get" action="/estadisticas/cotizaciones"
            class="row row-cols-lg-auto g-3 align-items-center justify-content-end" id="filtroForm">
            <div class="col-12">
                <span class="fw-bold text-muted small me-2"><i class="fas fa-filter"></i> Filtros:</span>
            </div>

            <!-- Periodo -->
            <div class="col-12">
                <select class="form-select form-select-sm" name="periodo" id="selectPeriodo" style="max-width: 150px;">
                    <option value="dia" {% if periodo_activo=='dia' %}selected{% endif %}>üìÖ Hoy</option>
                    <option value="semana" {% if periodo_activo=='semana' %}selected{% endif %}>üìÖ Esta Semana</option>
                    <option value="mes" {% if periodo_activo=='mes' %}selected{% endif %}>üìÖ Este Mes</option>
                    <option value="a√±o" {% if periodo_activo=='a√±o' %}selected{% endif %}>üìÖ Este A√±o</option>
                    <option value="personalizado" {% if periodo_activo=='personalizado' %}selected{% endif %}>‚öôÔ∏è
                        Personalizado</option>
                </select>
            </div>

            <div class="col-12" id="fechaInicioGroup"
                style="display: {% if periodo_activo == 'personalizado' %}block{% else %}none{% endif %};">
                <input type="text" class="form-control form-select-sm date-picker-input" name="fecha_inicio"
                    value="{{ fecha_inicio_activa or '' }}" placeholder="Inicio" style="max-width: 140px;">
            </div>

            <div class="col-12" id="fechaFinGroup"
                style="display: {% if periodo_activo == 'personalizado' %}block{% else %}none{% endif %};">
                <input type="text" class="form-control form-select-sm date-picker-input" name="fecha_fin"
                    value="{{ fecha_fin_activa or '' }}" placeholder="Fin" style="max-width: 140px;">
            </div>

            {% if current_user.tipo_usuario in ['administrador', 'supervisor'] %}
            <div class="col-12">
                <select class="form-select form-select-sm" name="agente_id" style="max-width: 180px;">
                    <option value="todos">üë§ Todos los agentes</option>
                    {% for agente in agentes %}
                    <option value="{{ agente.id }}" {% if agente_id_activo==agente.id|string %}selected{% endif %}>
                        {{ agente.username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <div class="col-12">
                <button type="submit" class="btn btn-primary btn-sm px-3 rounded-pill">
                    Aplicar
                </button>
            </div>
        </form>
        {% if fecha_inicio_formateada and fecha_fin_formateada %}
        <div class="text-end mt-1">
            <small class="text-muted" style="font-size: 0.7rem;">
                Mostrando: <strong>{{ fecha_inicio_formateada }}</strong> - <strong>{{ fecha_fin_formateada }}</strong>
            </small>
        </div>
        {% endif %}
    </div>
</div>

<!-- Resumen por Agente -->
<h6 class="text-muted fw-bold mb-3 text-uppercase small ls-1">Resumen por Agente</h6>
<div class="row g-3 mb-4">
    {% for agente in resumen_agentes %}
    <div class="col-6 col-md-3">
        <div class="card h-100 border-0 shadow-sm hover-up text-center">
            <div class="card-body p-3">
                <div class="icon-shape rounded-circle mb-2 bg-soft-success text-success mx-auto">
                    <i class="fas fa-file-invoice-dollar"></i>
                </div>
                <h6 class="card-title fw-bold mb-1">{{ agente.username }}</h6>
                <a href="/prospectos/filtro?tipo_filtro=estado&valor_filtro=cotizado&agente_asignado_id={{ agente.id }}&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}"
                    class="text-decoration-none text-dark">
                    <h3 class="mb-0 fw-bold">{{ agente.total }}</h3>
                </a>
                <small class="text-muted text-uppercase" style="font-size: 0.7rem;">Cotizaciones</small>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Detalle de Estad√≠sticas -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-0 py-3">
        <h5 class="card-title mb-0 text-primary fw-bold">Detalle de Cotizaciones por D√≠a</h5>
    </div>
    <div class="card-body p-0">
        {% if estadisticas %}
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light text-muted small">
                    <tr>
                        <th class="ps-4 py-3">Fecha</th>
                        <th class="py-3">Agente</th>
                        <th class="py-3">Cliente</th>
                        <th class="text-center py-3">Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stats in estadisticas %}
                    <tr>
                        <td class="ps-4 fw-bold text-dark">{{
                            stats.EstadisticaCotizacion.fecha_cotizacion.strftime('%d/%m/%Y') }}</td>
                        <td>
                            <span class="badge bg-soft-primary text-primary rounded-pill px-3">{{ stats.username
                                }}</span>
                        </td>
                        <td class="fw-500">
                            {{ stats.nombre }} {{ stats.apellido or '' }}
                        </td>
                        <td class="text-center">
                            <a href="/prospectos/{{ stats.prospecto_id }}/seguimiento"
                                class="btn btn-sm btn-outline-info rounded-pill px-3" target="_blank">
                                üìã Ver Seguimiento
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <div class="mb-3 text-muted opacity-50 display-4"><i class="fas fa-folder-open"></i></div>
            <p class="text-muted fw-bold">No hay datos para el periodo seleccionado.</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Inicializar datepicker globalmente (si no se ha hecho ya en base.html) pero los inputs ya tienen la clase

        // Mostrar/ocultar campos de fecha personalizada
        const selectPeriodo = document.getElementById('selectPeriodo');
        const fechaInicioGroup = document.getElementById('fechaInicioGroup');
        const fechaFinGroup = document.getElementById('fechaFinGroup');

        if (selectPeriodo) {
            selectPeriodo.addEventListener('change', function () {
                if (this.value === 'personalizado') {
                    fechaInicioGroup.style.display = 'block';
                    fechaFinGroup.style.display = 'block';
                } else {
                    fechaInicioGroup.style.display = 'none';
                    fechaFinGroup.style.display = 'none';
                }
            });
        }
    });
</script>
{% endblock %}