{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <small class="text-muted me-3">Fecha: {{ today }}</small>
        <a href="/prospectos/cerrados" class="btn btn-sm btn-outline-secondary">
            <i class="fas fa-archive"></i> Ver Historial Cerrados
        </a>
        <a href="/clientes/historial" class="btn btn-sm btn-outline-info ms-2">
            <i class="fas fa-history"></i> Historial Clientes
        </a>
    </div>
</div>

<!-- Filtros de Fecha -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0">Filtros de Fecha</h6>
    </div>
    <div class="card-body">
        <form method="get" action="/dashboard" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Periodo</label>
                <select class="form-select" name="periodo" id="selectPeriodo">
                    <option value="dia" {% if periodo_activo == 'dia' %}selected{% endif %}>Hoy</option>
                    <option value="semana" {% if periodo_activo == 'semana' %}selected{% endif %}>Esta Semana</option>
                    <option value="mes" {% if periodo_activo == 'mes' %}selected{% endif %}>Este Mes</option>
                    <option value="año" {% if periodo_activo == 'año' %}selected{% endif %}>Este Año</option>
                    <option value="personalizado" {% if periodo_activo == 'personalizado' %}selected{% endif %}>Personalizado</option>
                </select>
            </div>
            
            <div class="col-md-3" id="fechaInicioGroup" style="display: {% if periodo_activo == 'personalizado' %}block{% else %}none{% endif %};">
                <label class="form-label">Fecha Inicio</label>
                <input type="text" class="form-control" name="fecha_inicio" 
                       value="{{ fecha_inicio_activa or '' }}" placeholder="dd/mm/aaaa">
            </div>
            
            <div class="col-md-3" id="fechaFinGroup" style="display: {% if periodo_activo == 'personalizado' %}block{% else %}none{% endif %};">
                <label class="form-label">Fecha Fin</label>
                <input type="text" class="form-control" name="fecha_fin" 
                       value="{{ fecha_fin_activa or '' }}" placeholder="dd/mm/aaaa">
            </div>
            
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-filter"></i> Aplicar Filtros
                </button>
            </div>
        </form>
        
        <!-- Mostrar rango activo -->
        {% if fecha_inicio_formateada and fecha_fin_formateada %}
        <div class="mt-3">
            <small class="text-muted">
                Mostrando estadísticas del 
                <strong>{{ fecha_inicio_formateada }}</strong> al 
                <strong>{{ fecha_fin_formateada }}</strong>
            </small>
        </div>
        {% endif %}
    </div>
</div>

<div class="alert alert-info">
    <h4>¡Bienvenido {{ current_user.username }}!</h4>
    <p>Tipo de usuario: <strong>{{ current_user.tipo_usuario|title }}</strong></p>
    {% if current_user.tipo_usuario in ['administrador', 'supervisor'] %}
    <p class="mb-0">Puedes ver estadísticas generales del sistema</p>
    {% else %}
    <p class="mb-0">Estás viendo tus estadísticas personales</p>
    {% endif %}
</div>

<!-- Estadísticas Principales Compactas -->
<div class="row mb-4">
    <!-- Total Prospectos - Color: Púrpura Oscuro -->
    <div class="col-md-1 col-6 mb-2">
        <a href="/prospectos/filtro?tipo_filtro=total&valor_filtro=all&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
           class="text-decoration-none">
            <div class="card text-white bg-dark hover-shadow" style="background-color: #6f42c1 !important;">
                <div class="card-body text-center p-2">
                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Total</h6>
                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ total_prospectos }}</h4>
                    <small class="opacity-75" style="font-size: 0.7rem;">Prospectos</small>
                </div>
            </div>
        </a>
    </div>
    
    <!-- Con Datos - Color: Verde Claro -->
    <div class="col-md-1 col-6 mb-2">
        <a href="/prospectos/filtro?tipo_filtro=datos&valor_filtro=con_datos&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
           class="text-decoration-none">
            <div class="card text-dark bg-success hover-shadow" style="background-color: #20c997 !important;">
                <div class="card-body text-center p-2">
                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Con Datos</h6>
                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ prospectos_con_datos }}</h4>
                    <small class="opacity-75" style="font-size: 0.7rem;">Completos</small>
                </div>
            </div>
        </a>
    </div>
    
    <!-- Sin Datos - Color: Naranja -->
    <div class="col-md-1 col-6 mb-2">
        <a href="/prospectos/filtro?tipo_filtro=datos&valor_filtro=sin_datos&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
           class="text-decoration-none">
            <div class="card text-white bg-warning hover-shadow" style="background-color: #fd7e14 !important;">
                <div class="card-body text-center p-2">
                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Sin Datos</h6>
                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ prospectos_sin_datos }}</h4>
                    <small class="opacity-75" style="font-size: 0.7rem;">Solo teléfono</small>
                </div>
            </div>
        </a>
    </div>
    
    <!-- Sin Asignar (Solo Admin/Supervisor) - Color: Gris -->
    {% if current_user.tipo_usuario in ['administrador', 'supervisor'] %}
    <div class="col-md-1 col-6 mb-2">
        <a href="/prospectos/filtro?tipo_filtro=asignacion&valor_filtro=sin_asignar&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
           class="text-decoration-none">
            <div class="card text-white bg-secondary hover-shadow" style="background-color: #6c757d !important;">
                <div class="card-body text-center p-2">
                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Sin Asignar</h6>
                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ clientes_sin_asignar }}</h4>
                    <small class="opacity-75" style="font-size: 0.7rem;">Por asignar</small>
                </div>
            </div>
        </a>
    </div>
    {% endif %}
    
    <!-- Asignados - Color: Azul -->
    <div class="col-md-1 col-6 mb-2">
        <a href="/prospectos/filtro?tipo_filtro=asignacion&valor_filtro=asignados&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
           class="text-decoration-none">
            <div class="card text-white bg-info hover-shadow" style="background-color: #0d6efd !important;">
                <div class="card-body text-center p-2">
                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Asignados</h6>
                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ clientes_asignados }}</h4>
                    <small class="opacity-75" style="font-size: 0.7rem;">En seguimiento</small>
                </div>
            </div>
        </a>
    </div>
    
    <!-- Destinos - Color: Cyan -->
    <div class="col-md-1 col-6 mb-2">
        <div class="card text-dark" style="background-color: #0dcaf0 !important;">
            <div class="card-body text-center p-2">
                <h6 class="card-title mb-1" style="font-size: 0.8rem;">Destinos</h6>
                <h4 class="mb-0" style="font-size: 1.5rem;">{{ destinos_count }}</h4>
                <small class="opacity-75" style="font-size: 0.7rem;">Únicos</small>
            </div>
        </div>
    </div>
    
    <!-- Ventas - Color: Verde -->
    <div class="col-md-1 col-6 mb-2">
        <a href="/prospectos/filtro?tipo_filtro=ventas&valor_filtro=ganado&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
           class="text-decoration-none">
            <div class="card text-white bg-success hover-shadow" style="background-color: #198754 !important;">
                <div class="card-body text-center p-2">
                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Ventas</h6>
                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ ventas_count }}</h4>
                    <small class="opacity-75" style="font-size: 0.7rem;">Ganados</small>
                </div>
            </div>
        </a>
    </div>
</div>


<div class="row">
    <!-- Estadísticas por Estado -->
<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Estadísticas por Estado</h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="row mb-4">
                    <!-- Nuevos - Color: Gris Oscuro -->
                    <div class="col-md-1 col-6 mb-2">
                        <a href="/prospectos/filtro?tipo_filtro=estado&valor_filtro=nuevo&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
                        class="text-decoration-none">
                            <div class="card text-white" style="background-color: #495057 !important;">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Nuevos</h6>
                                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ prospectos_nuevos }}</h4>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- En Seguimiento - Color: Azul -->
                    <div class="col-md-1 col-6 mb-2">
                        <a href="/prospectos/filtro?tipo_filtro=estado&valor_filtro=en_seguimiento&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
                        class="text-decoration-none">
                            <div class="card text-white" style="background-color: #0d6efd !important;">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Seguimiento</h6>
                                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ prospectos_seguimiento }}</h4>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Cotizados - Color: Amarillo -->
                    <div class="col-md-1 col-6 mb-2">
                        <a href="/prospectos/filtro?tipo_filtro=estado&valor_filtro=cotizado&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
                        class="text-decoration-none">
                            <div class="card text-dark" style="background-color: #ffc107 !important;">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Cotizados</h6>
                                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ prospectos_cotizados }}</h4>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Ganados - Color: Verde -->
                    <div class="col-md-1 col-6 mb-2">
                        <a href="/prospectos/filtro?tipo_filtro=estado&valor_filtro=ganado&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
                        class="text-decoration-none">
                            <div class="card text-white" style="background-color: #198754 !important;">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Ganados</h6>
                                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ prospectos_ganados }}</h4>
                                </div>
                            </div>
                        </a>
                    </div>
                    
                    <!-- Cerrados/Perdidos - Color: Rojo -->
                    <div class="col-md-1 col-6 mb-2">
                        <a href="/prospectos/filtro?tipo_filtro=estado&valor_filtro=cerrado_perdido&fecha_inicio={{ fecha_inicio_activa or '' }}&fecha_fin={{ fecha_fin_activa or '' }}&periodo={{ periodo_activo }}" 
                        class="text-decoration-none">
                            <div class="card text-white" style="background-color: #dc3545 !important;">
                                <div class="card-body text-center p-2">
                                    <h6 class="card-title mb-1" style="font-size: 0.8rem;">Perdidos</h6>
                                    <h4 class="mb-0" style="font-size: 1.5rem;">{{ prospectos_perdidos }}</h4>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

    <!-- Destinos Populares -->
<div class="col-md-6">
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">Destinos Más Solicitados</h5>
        </div>
        <div class="card-body">
            {% if destinos_populares %}
                {% for destino in destinos_populares %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <a href="/prospectos/filtro?tipo_filtro=destino&valor_filtro={{ destino.destino or 'Sin destino' }}" 
                       class="text-decoration-none text-dark hover-text-primary">
                        <span>{{ destino.destino or 'Sin destino' }}</span>
                    </a>
                    <span class="badge bg-primary">{{ destino.count }}</span>
                </div>
                <div class="progress mb-3" style="height: 10px;">
                    <div class="progress-bar" role="progressbar" 
                         style="width: {{ (destino.count / (destinos_populares[0].count or 1) * 100)|round }}%">
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-muted">No hay datos de destinos en este periodo</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Conversión por Agente (Solo para Admin/Supervisor) -->
{% if current_user.tipo_usuario in ['administrador', 'supervisor'] and conversion_agentes %}
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Conversión por Agente</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Agente</th>
                                <th>Total Prospectos</th>
                                <th>Ventas</th>
                                <th>Tasa de Conversión</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for agente in conversion_agentes %}
                            <tr>
                                <td>{{ agente.username }}</td>
                                <td>{{ agente.total_prospectos }}</td>
                                <td>{{ agente.ganados or 0 }}</td>
                                <td>
                                    {% if agente.total_prospectos > 0 %}
                                        {{ ((agente.ganados or 0) / agente.total_prospectos * 100)|round(1) }}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="mt-4">
    <a href="/prospectos" class="btn btn-primary">Gestionar Prospectos</a>
    <a href="/clientes/historial" class="btn btn-info">Historial de Clientes</a>
    {% if current_user.tipo_usuario == 'administrador' %}
    <a href="/usuarios" class="btn btn-secondary">Gestionar Usuarios</a>
    {% endif %}
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar/ocultar campos de fecha personalizada
    const selectPeriodo = document.getElementById('selectPeriodo');
    const fechaInicioGroup = document.getElementById('fechaInicioGroup');
    const fechaFinGroup = document.getElementById('fechaFinGroup');
    
    selectPeriodo.addEventListener('change', function() {
        if (this.value === 'personalizado') {
            fechaInicioGroup.style.display = 'block';
            fechaFinGroup.style.display = 'block';
        } else {
            fechaInicioGroup.style.display = 'none';
            fechaFinGroup.style.display = 'none';
        }
    });
    
    // Formatear automáticamente las fechas mientras se escribe
    const fechaInputs = document.querySelectorAll('input[placeholder="dd/mm/aaaa"]');
    
    fechaInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.length >= 2) {
                value = value.substring(0, 2) + '/' + value.substring(2);
            }
            if (value.length >= 5) {
                value = value.substring(0, 5) + '/' + value.substring(5, 9);
            }
            
            e.target.value = value;
        });
    });
});
</script>

<style>
/* Dashboard Compacto - Todas las tarjetas en una fila */
.row.mb-4 {
    margin-left: -5px;
    margin-right: -5px;
    flex-wrap: nowrap !important;
    overflow-x: auto !important;
    overflow-y: hidden;
}

.row.mb-4::-webkit-scrollbar {
    height: 6px;
}

.row.mb-4::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.row.mb-4::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 3px;
}

.row.mb-4::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.row.mb-4 .col-md-1 {
    padding-left: 5px;
    padding-right: 5px;
    min-width: 110px !important;
    flex: 0 0 auto !important;
}

/* Tarjetas más compactas */
.card.hover-shadow {
    transition: transform 0.2s, box-shadow 0.2s;
    height: 100%;
    border: none;
    border-radius: 8px;
}

.card.hover-shadow:hover {
    transform: translateY(-3px) !important;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1) !important;
    cursor: pointer;
}

.card-body.p-2 {
    padding: 0.75rem !important;
}

/* Textos más pequeños para tarjetas compactas */
.card-title.mb-1 {
    font-size: 0.75rem !important;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.card h4.mb-0 {
    font-size: 1.4rem !important;
    font-weight: 700;
    line-height: 1.2;
}

small.opacity-75 {
    font-size: 0.65rem !important;
    opacity: 0.9;
    display: block;
    white-space: nowrap;
}

/* Color palette específica */
/* Total: Púrpura (#6f42c1) */
/* Con Datos: Verde Claro (#20c997) */
/* Sin Datos: Naranja (#fd7e14) */
/* Sin Asignar: Gris (#6c757d) */
/* Asignados: Azul (#0d6efd) */
/* Destinos: Cyan (#0dcaf0) */
/* Ventas: Verde (#198754) */

/* Badges con colores consistentes */
.bg-success-estado { background-color: #198754 !important; }
.bg-danger-estado { background-color: #dc3545 !important; }
.bg-primary-estado { background-color: #0d6efd !important; }
.bg-warning-estado { background-color: #ffc107 !important; color: #212529 !important; }
.bg-secondary-estado { background-color: #495057 !important; }

/* Responsive para pantallas muy pequeñas */
@media (max-width: 768px) {
    .row.mb-4 .col-md-1 {
        min-width: 100px !important;
    }
    
    .card-body.p-2 {
        padding: 0.5rem !important;
    }
    
    .card h4.mb-0 {
        font-size: 1.2rem !important;
    }
    
    .card-title.mb-1 {
        font-size: 0.7rem !important;
    }
}

/* Ajustar el contenedor principal */
.container {
    max-width: 100% !important;
    padding-left: 15px;
    padding-right: 15px;
}

/* Espaciado entre secciones */
.card.mb-4 {
    margin-bottom: 1.5rem !important;
}

/* Filtros más compactos */
.card .card-body {
    padding: 1rem !important;
}
</style>

<!-- ✅ AGREGAR DATEPICKER PARA FILTROS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar datepicker para campos de fecha
    const fechaInputs = document.querySelectorAll('input[placeholder="dd/mm/aaaa"]');
    
    fechaInputs.forEach(input => {
        flatpickr(input, {
            dateFormat: "d/m/Y",
            locale: "es",
            allowInput: true,
            disableMobile: true,
            onChange: function(selectedDates, dateStr, instance) {
                if (dateStr) {
                    instance.setDate(dateStr, true, "d/m/Y");
                }
            }
        });
    });
    
    // Mostrar/ocultar campos de fecha personalizada
    const selectPeriodo = document.getElementById('selectPeriodo');
    const fechaInicioGroup = document.getElementById('fechaInicioGroup');
    const fechaFinGroup = document.getElementById('fechaFinGroup');
    
    if (selectPeriodo) {
        selectPeriodo.addEventListener('change', function() {
            if (this.value === 'personalizado') {
                fechaInicioGroup.style.display = 'block';
                fechaFinGroup.style.display = 'block';
            } else {
                fechaInicioGroup.style.display = 'none';
                fechaFinGroup.style.display = 'none';
            }
        });
    }
    
    // Asegurar que todas las tarjetas tengan el mismo alto
    function ajustarAlturaTarjetas() {
        const tarjetas = document.querySelectorAll('.card.hover-shadow');
        let maxAltura = 0;
        
        // Encontrar la altura máxima
        tarjetas.forEach(tarjeta => {
            const altura = tarjeta.offsetHeight;
            if (altura > maxAltura) {
                maxAltura = altura;
            }
        });
        
        // Aplicar altura uniforme
        tarjetas.forEach(tarjeta => {
            tarjeta.style.minHeight = maxAltura + 'px';
        });
    }
    
    // Ejecutar al cargar y al redimensionar
    ajustarAlturaTarjetas();
    window.addEventListener('resize', ajustarAlturaTarjetas);
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Mostrar loading en formularios
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function() {
            const submitBtn = this.querySelector('button[type="submit"]');
            if (submitBtn && !submitBtn.disabled) {
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                submitBtn.disabled = true;
                
                // Restaurar después de 5 segundos por si hay error
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 5000);
            }
        });
    });
    
    // Auto-formato de fechas
    const fechaInputs = document.querySelectorAll('input[placeholder*="dd/mm/aaaa"]');
    fechaInputs.forEach(input => {
        input.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2);
            if (value.length >= 5) value = value.substring(0, 5) + '/' + value.substring(5, 9);
            e.target.value = value;
        });
    });
});
</script>
{% endblock %}