{% extends "base.html" %}

{% block title %}Confirmar Cliente Existente - Sistema de Prospectos{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <div class="card">
                <div class="card-header bg-warning">
                    <h4 class="card-title mb-0">‚ö†Ô∏è Cliente Ya Existente</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h5>Se encontr√≥ un cliente existente con el tel√©fono: <strong>{{ nuevos_datos.telefono
                                }}</strong></h5>
                    </div>

                    <!-- Informaci√≥n del Cliente Existente -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>üìã Cliente Existente - Registro M√°s Reciente</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Nombre:</strong>
                                        {% if cliente_existente_principal.nombre %}
                                        {{ cliente_existente_principal.nombre }} {{ cliente_existente_principal.apellido
                                        or '' }}
                                        {% else %}
                                        <span class="text-danger">Falta nombre/apellido</span>
                                        {% endif %}
                                    </p>
                                    <p><strong>Email:</strong>
                                        {% if cliente_existente_principal.correo_electronico %}
                                        {{ cliente_existente_principal.correo_electronico }}
                                        {% else %}
                                        <span class="text-danger">Falta email</span>
                                        {% endif %}
                                    </p>
                                    <p><strong>Total Registros:</strong> {{ registros_previos|length }}</p>
                                    <p><strong>Interacciones Totales:</strong> {{ interacciones_previas }}</p>
                                    <p><strong>Documentos:</strong> {{ documentos_previos }}</p>
                                    <p><strong>Estado Actual:</strong>
                                        <span class="badge bg-secondary">{{
                                            cliente_existente_principal.estado|replace('_', ' ')|title }}</span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6>üÜï Nuevo Registro (Datos del Formulario)</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Nombre:</strong>
                                        {% if nuevos_datos.nombre %}
                                        {{ nuevos_datos.nombre }} {{ nuevos_datos.apellido or '' }}
                                        <span class="badge bg-success">‚úÖ Del formulario</span>
                                        {% else %}
                                        <span class="text-warning">‚ö†Ô∏è Usar√° datos del cliente existente</span>
                                        {% endif %}
                                    </p>
                                    <p><strong>Email:</strong>
                                        {% if nuevos_datos.correo_electronico %}
                                        {{ nuevos_datos.correo_electronico }}
                                        <span class="badge bg-success">‚úÖ Del formulario</span>
                                        {% else %}
                                        <span class="text-warning">‚ö†Ô∏è Usar√° email del cliente existente</span>
                                        {% endif %}
                                    </p>
                                    <p><strong>Destino:</strong> {{ nuevos_datos.destino or 'N/A' }}</p>
                                    <p><strong>Fechas:</strong>
                                        {% if nuevos_datos.fecha_ida %}
                                        {{ nuevos_datos.fecha_ida }}
                                        {% if nuevos_datos.fecha_vuelta %} - {{ nuevos_datos.fecha_vuelta }}{% endif %}
                                        {% else %}
                                        N/A
                                        {% endif %}
                                    </p>

                                    <!-- ‚úÖ NUEVO: Indicador de datos que se transferir√°n -->
                                    <div class="alert alert-warning mt-3">
                                        <small>
                                            <strong>üìã Datos que se transferir√°n al nuevo registro:</strong><br>
                                            ‚Ä¢ Nombre: {% if nuevos_datos.nombre %}{{ nuevos_datos.nombre }}{% else %}Del
                                            cliente existente{% endif %}<br>
                                            ‚Ä¢ Apellido: {% if nuevos_datos.apellido %}{{ nuevos_datos.apellido }}{% else
                                            %}Del cliente existente{% endif %}<br>
                                            ‚Ä¢ Email: {% if nuevos_datos.correo_electronico %}{{
                                            nuevos_datos.correo_electronico }}{% else %}Del cliente existente{% endif %}
                                        </small>
                                    </div>

                                    <!-- ‚úÖ NUEVO: Seleccionar Agente -->
                                    <div class="mb-3">
                                        <label class="form-label"><strong>üìå Asignar a Agente:</strong></label>
                                        <select class="form-select" name="agente_asignado_id" id="selectAgente">
                                            <option value="0">Sin asignar</option>
                                            {% for agente in agentes %}
                                            <option value="{{ agente.id }}">
                                                {{ agente.username }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- √öltimas Interacciones -->
                    {% if ultimas_interacciones %}
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6>üìù √öltimas Interacciones del Cliente</h6>
                        </div>
                        <div class="card-body">
                            {% for interaccion in ultimas_interacciones %}
                            <div class="border-bottom pb-2 mb-2">
                                <small class="text-muted">{{ interaccion.fecha_creacion.strftime('%d/%m/%Y %H:%M')
                                    }}</small>
                                <p class="mb-1">{{ interaccion.descripcion }}</p>
                                <small class="badge bg-secondary">{{ interaccion.tipo_interaccion|title }}</small>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <!-- ‚úÖ NUEVO: Historial Completo de Registros (POSICI√ìN CORRECTA) -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6>üìä Historial de Registros del Cliente ({{ registros_previos|length }})</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Fecha Registro</th>
                                            <th>Destino</th>
                                            <th>Estado</th>
                                            <th>Agente</th>
                                            <th>Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for registro in registros_previos %}
                                        <tr>
                                            <td>{{ registro.id }}</td>
                                            <td>
                                                {% if registro.fecha_registro %}
                                                {{ registro.fecha_registro.strftime('%d/%m/%Y') }}
                                                {% else %}
                                                N/A
                                                {% endif %}
                                            </td>
                                            <td>{{ registro.destino or 'N/A' }}</td>
                                            <td>
                                                <span class="badge {% if registro.estado == 'nuevo' %}bg-secondary
                                                    {% elif registro.estado == 'en_seguimiento' %}bg-primary
                                                    {% elif registro.estado == 'cotizado' %}bg-warning
                                                    {% elif registro.estado == 'cerrado_perdido' %}bg-danger
                                                    {% else %}bg-success{% endif %}">
                                                    {{ registro.estado|replace('_', ' ')|title }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if registro.agente_asignado %}
                                                {{ registro.agente_asignado.username }}
                                                {% else %}
                                                <span class="text-muted">Sin asignar</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="/prospectos/{{ registro.id }}/seguimiento" target="_blank"
                                                    class="btn btn-sm btn-outline-info">
                                                    üìã Ver
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Opciones -->
                    <div class="row">
                        <div class="col-md-6">
                            <form method="post" action="/prospectos" id="formNuevoProspecto">
                                <!-- ‚úÖ AGREGAR CAMPOS CON AGENTE -->
                                <input type="hidden" name="forzar_nuevo" value="true">
                                <input type="hidden" name="telefono" value="{{ nuevos_datos.telefono }}">
                                <input type="hidden" name="indicativo_telefono"
                                    value="{{ nuevos_datos.indicativo_telefono or '57' }}">
                                <input type="hidden" name="medio_ingreso_id"
                                    value="{{ nuevos_datos.medio_ingreso_id }}">

                                <!-- ‚úÖ AGENTE ASIGNADO (si se seleccion√≥) -->
                                <input type="hidden" name="agente_asignado_id" id="inputAgenteId" value="">

                                <!-- ‚úÖ CAMPOS OPCIONALES -->
                                <input type="hidden" name="nombre" value="{{ nuevos_datos.nombre or '' }}">
                                <input type="hidden" name="apellido" value="{{ nuevos_datos.apellido or '' }}">
                                <input type="hidden" name="correo_electronico"
                                    value="{{ nuevos_datos.correo_electronico or '' }}">
                                <input type="hidden" name="ciudad_origen"
                                    value="{{ nuevos_datos.ciudad_origen or '' }}">
                                <input type="hidden" name="destino" value="{{ nuevos_datos.destino or '' }}">
                                <input type="hidden" name="fecha_ida" value="{{ nuevos_datos.fecha_ida or '' }}">
                                <input type="hidden" name="fecha_vuelta" value="{{ nuevos_datos.fecha_vuelta or '' }}">
                                <input type="hidden" name="pasajeros_adultos"
                                    value="{{ nuevos_datos.pasajeros_adultos }}">
                                <input type="hidden" name="pasajeros_ninos" value="{{ nuevos_datos.pasajeros_ninos }}">
                                <input type="hidden" name="pasajeros_infantes"
                                    value="{{ nuevos_datos.pasajeros_infantes }}">
                                <input type="hidden" name="observaciones"
                                    value="{{ nuevos_datos.observaciones or '' }}">

                                <button type="submit" class="btn btn-primary w-100 mb-2">
                                    ‚úÖ Registrar Como Nuevo Prospecto
                                </button>
                                <small class="text-muted">Se crear√° un nuevo registro para este viaje</small>
                            </form>
                        </div>

                        <div class="col-md-6">
                            <a href="/prospectos" class="btn btn-secondary w-100 mb-2">
                                ‚ùå Cancelar
                            </a>
                            <small class="text-muted">Volver sin guardar</small>
                        </div>
                    </div>

                    <!-- Enlace al cliente existente -->
                    <div class="text-center mt-3">
                        <a href="/buscar?tipo_id=cliente&valor_id={{ nuevos_datos.telefono }}" target="_blank"
                            class="btn btn-outline-info btn-sm">
                            üìã Ver Historial Completo del Cliente
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ‚úÖ CAPTURAR SELECCI√ìN DE AGENTE
        const selectAgente = document.getElementById('selectAgente');
        const inputAgenteId = document.getElementById('inputAgenteId');
        const formNuevoProspecto = document.getElementById('formNuevoProspecto');

        // ‚úÖ INICIALIZAR con "Sin asignar" por defecto
        if (inputAgenteId && !inputAgenteId.value) {
            inputAgenteId.value = "0";  // Valor por defecto: Sin asignar
        }

        // Actualizar input hidden con la selecci√≥n del agente
        if (selectAgente && inputAgenteId) {
            selectAgente.addEventListener('change', function () {
                inputAgenteId.value = this.value || "0";
                console.log("Agente seleccionado:", this.value);
            });

            // Inicializar con valor actual si existe
            if (selectAgente.value) {
                inputAgenteId.value = selectAgente.value;
            }
        }

        // ‚úÖ VERIFICAR QUE HAY AGENTES CARGADOS
        console.log("Agentes disponibles en select:", selectAgente ? selectAgente.options.length : 0);

        // ‚úÖ AGREGAR CAMPOS DE TEL√âFONO SECUNDARIO AL FORMULARIO
        const telefonoSecundario = "{{ nuevos_datos.telefono_secundario or '' }}";
        const indicativoSecundario = "{{ nuevos_datos.indicativo_telefono_secundario or '57' }}";

        if (telefonoSecundario && telefonoSecundario.trim()) {
            const inputTelefonoSecundario = document.createElement('input');
            inputTelefonoSecundario.type = 'hidden';
            inputTelefonoSecundario.name = 'telefono_secundario';
            inputTelefonoSecundario.value = telefonoSecundario.trim();
            formNuevoProspecto.appendChild(inputTelefonoSecundario);

            const inputIndicativoSecundario = document.createElement('input');
            inputIndicativoSecundario.type = 'hidden';
            inputIndicativoSecundario.name = 'indicativo_telefono_secundario';
            inputIndicativoSecundario.value = indicativoSecundario;
            formNuevoProspecto.appendChild(inputIndicativoSecundario);

            console.log("Tel√©fono secundario agregado:", telefonoSecundario);
        }

        // ‚úÖ DEPURACI√ìN: Mostrar datos que se enviar√°n
        formNuevoProspecto.addEventListener('submit', function (e) {
            console.log("=== DATOS A ENVIAR ===");
            const formData = new FormData(this);
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
        });
    });
</script>

<style>
    .form-select {
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}